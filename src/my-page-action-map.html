<html><head><link rel="import" href="../bower_components/polymer/polymer-element.html"><link rel="import" href="../bower_components/app-route/app-route.html"><link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html"><link rel="import" href="../bower_components/paper-listbox/paper-listbox.html"><link rel="import" href="../bower_components/paper-item/paper-item.html"><link rel="import" href="../bower_components/paper-button/paper-button.html"><link rel="import" href="../bower_components/paper-chip/paper-chip-input.html"><link rel="import" href="../bower_components/vaadin-grid/all-imports.html"><link rel="import" href="../bower_components/iron-ajax/iron-ajax.html"><link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html"><link rel="import" href="../bower_components/fluido-expansion-panel/fluido-expansion-panels.html"><link rel="import" href="shared-styles.html"></head><body><dom-module id="my-page-action-map"><template><style include="shared-styles">:host{display:block;--paper-chip-closed-label-max-width:200px;--paper-item:{padding:0 1rem;};--paper-listbox:{max-width:300px;};}.instruction{@apply --paper-font-body1;white-space:initial;color:var(--primary-text-color);}.instruction iron-icon{fill:var(--iron-icon-fill-color, var(--secondary-text-color));}paper-datatable-card{min-width:100%;--paper-datatable-selection-toolbar-color:var(--paper-orange-50);}vaadin-grid{height:calc(41px + (37px * 8));}paper-checkbox{margin-left:8px;--paper-checkbox-unchecked-color:var(--secondary-text-color);}.item-question{display:inline-block;min-width:56px;}.wrapper{width:99%;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}.details{@apply --paper-font-body1;color:var(--secondary-text-color);}[path]{@apply --paper-font-body2;color:var(--secondary-text-color);}.text{@apply --paper-font-body1;color:var(--primary-text-color);}div[slot="actions"] a{color:var(--primary-text-color);}</style><app-route route="{{route}}" pattern="mapa_de_acao" active="{{currentPage}}"></app-route><app-route route="{{route}}" pattern=":page" data="{{routeData}}" tail="{{diagroute}}"></app-route><app-route route="{{diagroute}}" pattern="/:diag" data="{{diagrouteData}}" tail="{{subroute}}"></app-route><app-route route="{{subroute}}" pattern="/:type" data="{{subrouteData}}"></app-route><h2>Resultados</h2><fluido-expansion-panels accordion=""><template is="dom-repeat" items="{{diags}}" as="diag"><fluido-expansion-panel panel-title="[[_testeName(diag.name)]]" panel-description="Atualizado em [[_dateToString(diag.date)]]" expanded="{{diag.open}}" on-expanded="_diagOpen"><p class="instruction">Encontre as prioridades por áreas apagando/clicando no<iron-icon icon="my-icons:close-circle" alt="botão fechar"></iron-icon>, ou digitando: Gestão Estratégica, Comercial, Administrativa, Financeira, Recursos Humanos, Tecnologia e Produção.</p><paper-chip-input label="Filtros" autocomplete="" values="{{diag.selectedFilters}}" on-chip-added="_addFilter" on-chip-removed="_removeFilter"><template is="dom-repeat" items="[[filters]]" as="f"><paper-chip value="[[f.value]]" removable="" single-line=""><span slot="label" class="label">[[f.label]]</span></paper-chip></template></paper-chip-input><vaadin-grid items="{{_computeFilterData(diag.questions, diag.selectedFilters)}}"><template class="row-details"><div class="details"><p>[[_computeQuestion(item.key)]]</p></div></template><vaadin-grid-column flex-grow="0" width="48px"><template class="header"></template><template><paper-checkbox checked="{{detailsOpened}}"></paper-checkbox></template></vaadin-grid-column><vaadin-grid-column flex-grow="1" width="224px"><template class="header"><vaadin-grid-sorter path="question">Pergunta</vaadin-grid-sorter></template><template><div class="wrapper text"><span class="item-question">[[item.key]]</span> <span class="item-question-data">[[_computeQuestion(item.key)]]</span></div></template></vaadin-grid-column><vaadin-grid-column flex-grow="0" width="64px"><template class="header"><vaadin-grid-sorter path="gravity">G</vaadin-grid-sorter></template><template><div class="text">[[item.gravity]]</div></template></vaadin-grid-column><vaadin-grid-column flex-grow="0" width="64px"><template class="header"><vaadin-grid-sorter path="urgency">U</vaadin-grid-sorter></template><template><div class="text">[[item.urgency]]</div></template></vaadin-grid-column><vaadin-grid-column flex-grow="0" width="64px"><template class="header"><vaadin-grid-sorter path="trend">F</vaadin-grid-sorter></template><template><div class="text">[[item.trend]]</div></template></vaadin-grid-column><vaadin-grid-column flex-grow="0" width="128px"><template class="header"><vaadin-grid-sorter path="score">Pontuação</vaadin-grid-sorter></template><template><div class="text"><span>[[_computeScore(item)]]</span></div></template></vaadin-grid-column></vaadin-grid><div slot="actions"><a href="http://mapee.com.br/" target="_blank"><paper-button>Dados para aplicação</paper-button></a><paper-button on-click="printPage">Imprimir</paper-button></div></fluido-expansion-panel></template></fluido-expansion-panels><iron-ajax id="printPDF" url="[[apiURL]]/diag/action-pdf" content-type="application/json" handle-as="blob" method="POST" on-response="_downloadPDF"></iron-ajax></template><script>class MyPageActionMap extends Polymer.Element{static get is(){return"my-page-action-map"}static get properties(){return{apiURL:{type:String,readOnly:!0,value(){return window.apiURL}},route:{type:String,notify:!0},routeData:{type:Object,notify:!0},diagrouteData:{type:Object,notify:!0},subrouteData:{type:Object,notify:!0},currentPage:{type:Boolean,value:!1},question1h:{type:Object,notify:!0},question1w:{type:Object,notify:!0},question2w:{type:Object,notify:!0},question3w:{type:Object,notify:!0},question4w:{type:Object,notify:!0},question5w:{type:Object,notify:!0},diags:{type:Array,notify:!0,value(){return[]}},filters:{type:Array,readOnly:!0,value(){return[{value:"administrativa",label:"Administrativa"},{value:"gest\xE3o estrat\xE9gica",label:"Gest\xE3o Estrat\xE9gica"},{value:"financeira",label:"Financeira"},{value:"tecnologia e produ\xE7\xE3o",label:"Tecnologia e Produ\xE7\xE3o"},{value:"comercial",label:"Comercial"},{value:"recursos humanos",label:"Recursos Humanos"}]}},openDiag:{type:String,notify:!0},_isEmpty:{type:Boolean,computed:"_computeDiags(diags)"}}}static get observers(){return["_changePage(currentPage)","_openDiagLink(diagrouteData.diag)"]}_changePage(active){if(active){window.dispatchEvent(new CustomEvent("page-response",{detail:{drawerOpen:!0,title:"Mapa de a\xE7\xE3o"}}));this.question1h=JSON.parse(window.localStorage.mapee_question_1h);this.question1w=JSON.parse(window.localStorage.mapee_question_1w);this.question2w=JSON.parse(window.localStorage.mapee_question_2w);this.question3w=JSON.parse(window.localStorage.mapee_question_3w);this.question4w=JSON.parse(window.localStorage.mapee_question_4w);this.question5w=JSON.parse(window.localStorage.mapee_question_5w);if(this.openDiag)window.setLocation(`mapa_de_acao/${this.openDiag}`,!0);this.update()}}update(){window.getTransactionMapeeDiag().store.getAll().onsuccess=ev=>{ev.target.result.sort((a,b)=>{let da=new Date(a.date),db=new Date(b.date);return db.getTime()-da.getTime()});this.set("diags",ev.target.result);for(let i=0;i<this.diags.length;i++){if(this.diags[i]._id==this.diagrouteData.diag)this.diags[i].open=!0;else this.diags[i].open=!1;this.diags[i].selectedFilters=[];for(let j=0;j<this.filters.length;j++){this.diags[i].selectedFilters.push(this.filters[j].value)}this.notifyPath(`diags.${i}.selectedFilters`);this.notifyPath(`diags.${i}.selectedFilters.*`)}}}_computeDiags(diags){return diags&&0>=diags.length}_testeName(name){return name?name:"Diagn\xF3stico sem nome"}_dateToString(date){date=new Date(date);let res=`${date.getDate()}/`.padStart(3,0);res+=`${date.getMonth()+1}/`.padStart(3,0);res+=`${date.getFullYear()}`;return res}_computeScore(item){item.score=Math.cbrt(item.gravity*item.urgency*item.trend).toFixed(2);return item.score}_addFilter(e){this.notifyPath(`diags.${e.model.index}.selectedFilters`);this.notifyPath(`diags.${e.model.index}.selectedFilters.*`)}_removeFilter(e){this.notifyPath(`diags.${e.model.index}.selectedFilters`);this.notifyPath(`diags.${e.model.index}.selectedFilters.*`)}_computeFilterData(questions,filters){let res=[];for(let i=0;i<questions.length;i++){if(!questions[i].completed)continue;let qg=this[`question${questions[i].key.slice(0,2)}`],department=qg[questions[i].key].department;if(filters&&0<=filters.indexOf(department)){res.push(questions[i])}}return res}_computeQuestion(q){let qg=this[`question${q.slice(0,2)}`];return qg[q].question}_diagOpen(e){if(!e.detail.expanded&&e.model.diag._id==this.openDiag){this.openDiag=null;if(this.currentPage)window.setLocation(`mapa_de_acao`,!0)}else if(e.detail.expanded){this.openDiag=e.model.diag._id;if(this.currentPage)window.setLocation(`mapa_de_acao/${e.model.diag._id}`,!0)}}_openDiagLink(diag){this.openDiag=diag;if(!diag||this.openDiag==diag)return;for(let i=0;i<this.diags.length;i++){if(this.diags[i]._id==diag)this.set(["diags",i,"open"],!0);else this.set(["diags",i,"open"],!1)}}getApiKey(cb){window.getTransactionMapeeUser(!0).store.getAll().onsuccess=ev=>{let user=ev.target.result[0];if(user&&user.apiKey){cb(user.apiKey)}}}printPage(ev){let data={date:ev.model.diag.date,diag:this._testeName(ev.model.diag.name),questions:JSON.parse(JSON.stringify(this._computeFilterData(ev.model.diag.questions,ev.model.diag.selectedFilters))),filter:ev.model.diag.selectedFilters.join(", ").toUpperCase()};data.questions.forEach(e=>{e.question=this._computeQuestion(e.key)});window.globalWaiting(!0);this.getApiKey(key=>{this.$.printPDF.body=babelHelpers.objectSpread({key},data);this.$.printPDF.generateRequest()})}_downloadPDF(ev){window.globalWaiting(!1);let blob=new Blob([ev.detail.xhr.response],{type:"application/pdf"}),link=document.createElement("a");link.href=window.URL.createObjectURL(blob);link.download="Mapa para A\xE7\xE3o - Mapee.pdf";link.click()}}window.customElements.define(MyPageActionMap.is,MyPageActionMap);</script></dom-module></body></html>