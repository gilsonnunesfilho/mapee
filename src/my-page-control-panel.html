<html><head><link rel="import" href="../bower_components/polymer/polymer-element.html"><link rel="import" href="../bower_components/app-route/app-route.html"><link rel="import" href="../bower_components/paper-item/paper-item.html"><link rel="import" href="../bower_components/paper-button/paper-button.html"><link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html"><link rel="import" href="../bower_components/paper-listbox/paper-listbox.html"><link rel="import" href="../bower_components/iron-ajax/iron-ajax.html"><link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html"><link rel="import" href="../bower_components/fluido-expansion-panel/fluido-expansion-panels.html"><link rel="import" href="../bower_components/google-chart/google-chart.html"><link rel="import" href="mapee-components/paper-diagnostic/paper-diagnostic.html"><link rel="import" href="my-icons.html"><link rel="import" href="shared-styles.html"></head><body><dom-module id="my-page-control-panel"><template><style include="shared-styles">:host{width:100%;--expanded-panel-actions:{justify-content:space-between;};}paper-menu-button{padding:0;}paper-item{--paper-item:{padding:0 16px;white-space:nowrap;};}paper-dialog{z-index:103;}.empty-p{padding:0 1.5rem;}.example-fab{display:inline-flex;justify-content:center;color:white;background-color:var(--accent-color);font-size:.8em;font-weight:300;line-height:23px;width:24px;height:24px;border-radius:50%;}.empty-bg{position:absolute;top:0;right:0;bottom:0;left:0;z-index:-1;}.empty-bg::after{content:"";position:absolute;width:56px;height:56px;border-radius:50%;bottom:24px;right:24px;box-shadow:0 0 0 rgba(228, 96, 48, 0.6);animation:pulse 5s infinite;}@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(228, 96, 48, 0.6);}40%{box-shadow:0 0 0 120px rgba(228, 96, 48, 0);}70%{box-shadow:0 0 0 0 rgba(228, 96, 48, 0);}100%{box-shadow:0 0 0 0 rgba(228, 96, 48, 0);}}.charts-nav-wrapper{position:relative;}paper-icon-button[icon="my-icons:chevron-left"],
			paper-icon-button[icon="my-icons:chevron-right"]{position:absolute;top:50%;transform:translate3d(0, -50%, 0);border-radius:50%;background-color:white;@apply --shadow-elevation-2dp;z-index:10;}paper-icon-button[icon="my-icons:chevron-left"]{left:0;}paper-icon-button[icon="my-icons:chevron-right"]{right:0;}.charts-wrapper{height:11.75rem;overflow:hidden;margin-bottom:-15px;margin-left:-1.5rem;margin-right:-1.5rem;box-sizing:border-box;}.charts{height:14rem;display:flex;flex-flow:row nowrap;overflow-x:auto;box-sizing:border-box;}.chart{flex:0 1 auto;height:12.25rem;display:flex;flex-flow:column nowrap;justify-content:center;align-items:center;box-sizing:border-box;padding:0 1rem;}.chart:first-of-type{padding-left:5rem;}.chart:last-of-type{padding-right:5rem;}.chart>h3{@apply --paper-font-caption;color:var(--secondary-text-color);margin-bottom:-1.5rem;}google-chart{width:272px;height:152px;}</style><app-route route="{{route}}" pattern="painel_de_controle" active="{{currentPage}}"></app-route><app-route route="{{route}}" pattern=":page" data="{{routeData}}" tail="{{diagroute}}"></app-route><app-route route="{{diagroute}}" pattern="/:diag" data="{{diagrouteData}}" tail="{{subroute}}"></app-route><app-route route="{{subroute}}" pattern="/:type" data="{{subrouteData}}"></app-route><template is="dom-if" if="[[!_isEmpty]]"><h2>Diagnósticos</h2><fluido-expansion-panels accordion=""><template is="dom-repeat" items="[[diags]]" as="diag"><fluido-expansion-panel panel-title="[[_testeName(diag.name)]]" panel-description="Atualizado em [[_dateToString(diag.date)]]" expanded="{{diag.open}}" on-expanded="_diagOpen"><paper-diagnostic answers="[[diag.score]]" on-question-click="continueSelected"><div class="charts-nav-wrapper"><paper-icon-button aria-hidden="true" on-click="_scrollBackwards" icon="my-icons:chevron-left"></paper-icon-button><div class="charts-wrapper"><main id="chartsContainer[[index]]" class="charts"><section class="chart"><h3>Gravidade</h3><google-chart type="pie" options="[[chartOptions]]" cols="[{&quot;label&quot;: &quot;Valor&quot;, &quot;type&quot;: &quot;string&quot;}, {&quot;label&quot;: &quot;Valor&quot;, &quot;type&quot;: &quot;number&quot;}]" rows="[[_calcPieChart('gravity', diag.graphic.gravity)]]"></google-chart></section><section class="chart"><h3>Urgência</h3><google-chart type="pie" options="[[chartOptions]]" cols="[{&quot;label&quot;: &quot;Valor&quot;, &quot;type&quot;: &quot;string&quot;}, {&quot;label&quot;: &quot;Valor&quot;, &quot;type&quot;: &quot;number&quot;}]" rows="[[_calcPieChart('urgency', diag.graphic.urgency)]]"></google-chart></section><section class="chart"><h3>Futuro</h3><google-chart type="pie" options="[[chartOptions]]" cols="[{&quot;label&quot;: &quot;Valor&quot;, &quot;type&quot;: &quot;string&quot;}, {&quot;label&quot;: &quot;Valor&quot;, &quot;type&quot;: &quot;number&quot;}]" rows="[[_calcPieChart('trend', diag.graphic.trend)]]"></google-chart></section></main></div><paper-icon-button aria-hidden="true" on-click="_scrollForwards" icon="my-icons:chevron-right"></paper-icon-button></div></paper-diagnostic><div slot="actions"><paper-button on-click="continue">Continuar diagnóstico</paper-button><paper-menu-button id="moreActions" vertical-align="bottom" horizontal-align="right"><paper-icon-button icon="my-icons:more-vert" slot="dropdown-trigger"></paper-icon-button><paper-listbox slot="dropdown-content"><paper-item on-click="openDeleteDialog">Excluir este diagnóstico</paper-item><paper-item on-click="restart">Zerar e reiniciar</paper-item></paper-listbox></paper-menu-button></div></fluido-expansion-panel></template></fluido-expansion-panels></template><template is="dom-if" if="[[_isEmpty]]"><h2>Você ainda não tem nenhum diagnostico.</h2><p class="empty-p">Para criar novos diagnósticos, clique no botão <span class="example-fab">+</span> no canto inferior direito da sua tela.</p><div class="empty-bg"></div></template><iron-ajax id="diag_ajax" url="[[apiURL]]/diag/all" content-type="application/json" handle-as="json" method="GET" on-response="_diagsResponse"></iron-ajax><iron-ajax id="delete_diag_ajax" url="[[apiURL]]/diag/remove" content-type="application/json" handle-as="json" method="POST" on-response="_deleteDiagHandle"></iron-ajax></template><script>class MyPageControlPainel extends Polymer.Element{static get is(){return"my-page-control-panel"}static get properties(){return{apiKey:{type:String,notify:!0},apiURL:{type:String,readOnly:!0,value(){return window.apiURL}},route:{type:String,notify:!0},routeData:{type:Object,notify:!0},diagrouteData:{type:Object,notify:!0},subrouteData:{type:Object,notify:!0},_isEmpty:{type:Boolean,value:!0,computed:"_computeDiags(diags)"},apiURL:{type:String,readOnly:!0,value(){return window.apiURL}},currentPage:{type:Boolean,value:!1},question1h:{type:Object,notify:!0},question1w:{type:Object,notify:!0},question2w:{type:Object,notify:!0},question3w:{type:Object,notify:!0},question4w:{type:Object,notify:!0},question5w:{type:Object,notify:!0},openDiag:{type:String,notify:!0},diags:{type:Array,notify:!0},chartOptions:{type:Object,value(){return{legend:{position:"right",alignment:"center",textStyle:{color:"#737373",fontName:"Roboto",fontSize:12}},pieSliceText:"none",backgroundColor:"transparent",width:272,height:152,tooltip:{trigger:"selection",showColorCode:!0,textStyle:{color:"#737373",fontName:"Roboto",fontSize:12}},chartArea:{left:16,top:16,width:"152",height:"152"},pieSliceBorderColor:"transparent",slices:{0:{color:"#e46030"},1:{color:"#ff915c"},2:{color:"#eeeeee"},3:{color:"#51936b"},4:{color:"#216540"}}}}},graphicLabels:{type:Object,readOnly:!0,value(){return{gravity:["Extremamente grave","\xC9 grave","M\xE9dia gravidade","Pouco grave","Sem gravidade"],urgency:["Extremamente urgente","Com urg\xEAncia","M\xE9dia urg\xEAncia","Pouco urgente","Sem urg\xEAncia"],trend:["J\xE1 est\xE1 piorando","Piorar em pouco tempo","Piorar a m\xE9dio prazo","Piorar num longo prazo","Ficar bem"]}}}}}static get observers(){return["_changePage(currentPage)","_openDiagLink(diagrouteData.diag)","_subrouteChange(subrouteData.type)"]}ready(){super.ready();window.addEventListener("fabadd-action",(()=>{window.setLocation("diagnosticos/new")}).bind(this))}_changePage(active){if(active){window.dispatchEvent(new CustomEvent("page-response",{detail:{drawerOpen:!0,title:"Painel de controle"}}));this.question1h=JSON.parse(window.localStorage.mapee_question_1h);this.question1w=JSON.parse(window.localStorage.mapee_question_1w);this.question2w=JSON.parse(window.localStorage.mapee_question_2w);this.question3w=JSON.parse(window.localStorage.mapee_question_3w);this.question4w=JSON.parse(window.localStorage.mapee_question_4w);this.question5w=JSON.parse(window.localStorage.mapee_question_5w);if(this.openDiag)window.setLocation(`painel_de_controle/${this.openDiag}`,!0);this.reload()}}reload(){if(navigator.onLine){window.getTransactionMapeeUser(!0).store.getAll().onsuccess=ev=>{let user=ev.target.result[0];if(user&&user.apiKey){this.$.diag_ajax.params={key:user.apiKey};this.$.diag_ajax.generateRequest()}};window.globalWaiting(!0)}else{this.update()}}update(diags){if(diags){let txDiags=window.getTransactionMapeeDiag().store;if(!diags||0>=diags.length)this.update();else for(let i in diags){let req=txDiags.put(diags[i]);if(i+1>=diags.length)req.onsuccess=()=>{this.update()}}}else{window.getTransactionMapeeDiag().store.getAll().onsuccess=ev=>{ev.target.result.sort((a,b)=>{let da=new Date(a.date),db=new Date(b.date);return db.getTime()-da.getTime()});this.set("diags",ev.target.result);for(let i=0;i<this.diags.length;i++){if(this.diags[i]._id==this.diagrouteData.diag)this.diags[i].open=!0;else this.diags[i].open=!1}}}}_diagsResponse(e){let result=e.detail.response;window.globalWaiting(!1);if(result){for(let i=0;i<result.length;i++){for(let r in result[i].score){result[i].score[r].qSize=Object.keys(this[`question${r}`]).length}}this.update(result)}}_diagOpen(e){if(!e.detail.expanded&&e.model.diag._id==this.openDiag){this.openDiag=null;if(this.currentPage)window.setLocation(`painel_de_controle`,!0)}else if(e.detail.expanded){this.openDiag=e.model.diag._id;if(this.currentPage)window.setLocation(`painel_de_controle/${e.model.diag._id}`,!0)}}_openDiagLink(diag){if(!diag||this.openDiag==diag)return;this.openDiag=diag;if(this.diags){for(let i=0;i<this.diags.length;i++){if(this.diags[i]._id==diag)this.set(["diags",i,"open"],!0);else this.set(["diags",i,"open"],!1)}}else if(!1!==this.realoading){setTimeout(()=>{this._openDiagLink(diag)},200)}}_computeDiags(diags){return diags&&0>=diags.length}_testeName(name){return name?name:"Diagn\xF3stico sem nome"}_dateToString(date){date=new Date(date);let res=`${date.getDate()}/`.padStart(3,0);res+=`${date.getMonth()+1}/`.padStart(3,0);res+=`${date.getFullYear()}`;return res}_calcPieChart(type,data){let res=[],test=!0;if(data)for(let i=0;i<data.length;i++){if(test&&0<data[i])test=!1;res[i]=[this.graphicLabels[type][i],data[i]]}return test?[["Sem dados",1]]:res}continue(e){window.setLocation(`diagnosticos/${e.model.diag._id}/continue`)}continueSelected(e){window.setLocation(`diagnosticos/${e.model.diag._id}/${e.detail.question}`)}openDeleteDialog(e){window.setLocation(`painel_de_controle/${e.model.diag._id}/delete`)}restart(e){window.setLocation(`painel_de_controle/${e.model.diag._id}/restart`)}_subrouteChange(type){if(this.currentPage&&"delete"===type){window.dispatchEvent(new CustomEvent("open-dialog",{detail:{title:"Remo\xE7\xE3o do Diagnostico",content:"Tem certeza que deseja exluir esse diagnostico?",buttons:[{label:"excluir",value:"",callback:()=>{window.getTransactionMapeeUser().store.getAll().onsuccess=ev=>{let user=ev.target.result[0];if(user&&user.apiKey){window.getTransactionMapeeDiag().store.delete(this.diagrouteData.diag);this.$.delete_diag_ajax.body={id:this.diagrouteData.diag,key:user.apiKey};this.$.delete_diag_ajax.generateRequest()}};window.globalWaiting(!0)}}]}}))}else if(this.currentPage&&"restart"===type){window.dispatchEvent(new CustomEvent("open-dialog",{detail:{title:"Zerando o Diagnostico",content:"Tem certeza que deseja reiniciar esse diagnostico?",buttons:[{label:"sim",value:"",callback:()=>{window.setLocation(`diagnosticos/${this.diagrouteData.diag}/restart`)}}]}}))}}_deleteDiagHandle(e){window.globalWaiting(!1);let result=e.detail.response;this.reload();window.setLocation(`painel_de_controle`);if(!result.success){console.log(result)}}_scrollForwards(e){this.shadowRoot.querySelector(`#chartsContainer${e.model.index}`).scrollLeft+=this.chartOptions.width/2}_scrollBackwards(e){this.shadowRoot.querySelector(`#chartsContainer${e.model.index}`).scrollLeft-=this.chartOptions.width/2}}window.customElements.define(MyPageControlPainel.is,MyPageControlPainel);</script></dom-module></body></html>