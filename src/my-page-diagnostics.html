<html><head><link rel="import" href="../bower_components/polymer/polymer-element.html"><link rel="import" href="../bower_components/app-route/app-route.html"><link rel="import" href="../bower_components/paper-card/paper-card.html"><link rel="import" href="../bower_components/paper-button/paper-button.html"><link rel="import" href="../bower_components/paper-input/paper-input.html"><link rel="import" href="../bower_components/iron-ajax/iron-ajax.html"><link rel="import" href="../bower_components/iron-media-query/iron-media-query.html"><link rel="import" href="../bower_components/fluido-stepper/fluido-stepper.html"><link rel="import" href="mapee-components/gut-content/gut-content.html"><link rel="import" href="mapee-components/next-questions/next-questions.html"><link rel="import" href="mapee-components/diagnostics-skeleton/diagnostics-skeleton.html"><link rel="import" href="shared-styles.html"></head><body><dom-module id="my-page-diagnostics"><template><style include="shared-styles diagnostics-skeleton">:host{display:block;}header{padding:0 1em 1em;box-sizing:border-box;display:flex;align-items:center;min-height:80px;}.header-title{@apply --paper-font-headline;margin-right:16px;color:var(--primary-text-color);}.header-subtitle{@apply --paper-font-body2;color:var(--secondary-text-color);}.question-wrapper{padding:1.5em;box-sizing:border-box;min-height:96px;position:relative;}.question{@apply --paper-font-subhead;margin:0;}.question span{text-transform:uppercase;}paper-card{width:100%;overflow:hidden;position:relative;--paper-card-actions:{display:flex;flex-direction:column;};}paper-progress{top:0;}paper-button{@apply --paper-font-button;--paper-button:{justify-content:flex-start;};}aside{width:100%;display:flex;}@media screen and (min-width: 22.5em){paper-card{--paper-card-actions:{display:block;};}paper-button{--paper-button:{justify-content:center;};}}@media screen and (min-width: 64em){paper-card{width:calc(100% - 21.5em);}aside{width:18em;float:right;margin-left:3em;}}</style><iron-media-query query="(min-width: 600px)" query-matches="{{queryMatches}}"></iron-media-query><app-route route="{{route}}" pattern="diagnosticos" data="{{routeData}}" tail="{{diagroute}}" active="{{currentPage}}"></app-route><app-route route="{{diagroute}}" pattern="/:diag" data="{{diagrouteData}}" tail="{{subroute}}"></app-route><app-route route="{{subroute}}" pattern="/:type" data="{{subrouteData}}"></app-route><header id="diagnostic-header"><h1 class="header-title">[[_composeQuestionDescription(subrouteData.type, questionDescription, 'type')]]</h1><span class="header-subtitle">[[_composeQuestionDescription(subrouteData.type, questionDescription, 'description')]]</span></header><paper-card><div class="question-wrapper"><p class="question"><span>[[question.key]] - </span>[[_computeQuestionData(question.key)]]</p></div><fluido-stepper vertical="{{queryMatches}}" autostart=""><template is="dom-repeat" items="[[gutQuestions]]" as="gut"><fluido-step id="step[[index]]" title="[[gut.title]]" subtitle="[[gut.answer]]" editable=""><gut-content description="[[gut.description]]" gut-buttons="[[gut.buttons]]" on-response="_handleAnswer"></gut-content></fluido-step></template></fluido-stepper><div class="card-actions"><paper-button on-click="_questionClickFinish">Concluir</paper-button><paper-button on-click="_questionClickJump">Pular</paper-button><paper-button on-click="_questionClickIgnore">NÃ£o se aplica</paper-button></div></paper-card><aside><next-questions id="nquestions" questions="[[questionsGroup]]" question="[[subrouteData.type]]" on-action="_selectNextQuestion"></next-questions></aside><iron-ajax id="diag_status_ajax" url="[[apiURL]]/diag/get" content-type="application/json" handle-as="json" method="GET" on-response="_responseQuestionary"></iron-ajax><iron-ajax id="question_save_ajax" url="[[apiURL]]/diag/question/save" content-type="application/json" handle-as="json" method="POST" on-response="_saveQuestionHandler"></iron-ajax><iron-ajax id="question_reset_ajax" url="[[apiURL]]/diag/question/reset" content-type="application/json" handle-as="json" method="POST" on-response="_resetQuestionHandler"></iron-ajax><iron-ajax id="title_save_ajax" url="[[apiURL]]/diag/save" content-type="application/json" handle-as="json" method="POST" on-response="_saveTitleHandler"></iron-ajax></template><script>class MyPageDiagnostics extends Polymer.Element{static get is(){return"my-page-diagnostics"}static get properties(){return{apiURL:{type:String,readOnly:!0,value(){return window.apiURL}},route:{type:String,notify:!0},routeData:{type:Object,notify:!0},diagrouteData:{type:Object,notify:!0},subrouteData:{type:Object,notify:!0},currentPage:{type:Boolean,value:!1},question1h:{type:Object,notify:!0},question1w:{type:Object,notify:!0},question2w:{type:Object,notify:!0},question3w:{type:Object,notify:!0},question4w:{type:Object,notify:!0},question5w:{type:Object,notify:!0},gutQuestions:{type:Array,value(){return[{title:"Gravidade",answer:"",index:0,description:"Sobre esta quest\xE3o, como \xE9 percebida a situa\xE7\xE3o da sua empresa?",buttons:[{color:"worst",title:"Extremamente grave",value:1},{color:"bad",title:"\xC9 grave",value:2},{color:"neutral",title:"M\xE9dia gravidade",value:3},{color:"good",title:"Pouco grave",value:4},{color:"best",title:"Sem gravidade",value:5}]},{title:"Urg\xEAncia",answer:"",index:1,description:"Qual a necessidade de agir neste ponto no caso da sua empresa?",buttons:[{color:"worst",title:"Extremamente urgente",value:1},{color:"bad",title:"Com urg\xEAncia",value:2},{color:"neutral",title:"M\xE9dia urg\xEAncia",value:3},{color:"good",title:"Pouco urgente",value:4},{color:"best",title:"Sem urg\xEAncia",value:5}]},{title:"Futuro",answer:"",index:2,description:"Qual a tend\xEAncia dessa quest\xE3o sobre a empresa, sem uma a\xE7\xE3o intervindo nela?",buttons:[{color:"worst",title:"J\xE1 est\xE1 piorando",value:1},{color:"bad",title:"Piorar em pouco tempo",value:2},{color:"neutral",title:"Piorar a m\xE9dio prazo",value:3},{color:"good",title:"Piorar num longo prazo",value:4},{color:"best",title:"Ficar bem",value:5}]}]}},loading:{type:Boolean,value:!1},loadingDiag:{type:Boolean,value:!1},loadingQuestion:{type:Boolean,value:!1},diagnostic:{type:Object,value(){return{}},notify:!0},question:{type:Object,value(){return{}},notify:!0},questionDescription:{type:Array,notify:!0},questionsGroup:{type:Array,notify:!0}}}_loading(a,b,c){window.globalWaiting(a||b||c)}onListenTitle(){this.titleEvent=e=>{this._changeTitle(e)};window.addEventListener("title-confirm",this.titleEvent)}offListenTitle(){window.removeEventListener("title-confirm",this.titleEvent)}_changeTitle(e){window.globalWaiting(!0);this.getApiKey(key=>{this.$.title_save_ajax.body={key,id:this.diagrouteData.diag,name:e.detail.title};this.$.title_save_ajax.generateRequest()})}_saveTitleHandler(e){window.globalWaiting(!1);let res=e.detail.response;if(!res.success){console.log(e.detail.response)}}getApiKey(cb){window.getTransactionMapeeUser(!0).store.getAll().onsuccess=ev=>{let user=ev.target.result[0];if(user&&user.apiKey){cb(user.apiKey)}}}static get observers(){return["_loading(loading, loadingDiag, loadingQuestion)","_changePage(currentPage)","_changeDiag(currentPage, diagrouteData.diag, subrouteData.type)"]}_changePage(active){if(active){window.dispatchEvent(new CustomEvent("page-response",{detail:{title:"Diagnosticos",titleAriaLabel:"Editar nome do Diagnostico"}}));this.question1h=JSON.parse(window.localStorage.mapee_question_1h);this.question1w=JSON.parse(window.localStorage.mapee_question_1w);this.question2w=JSON.parse(window.localStorage.mapee_question_2w);this.question3w=JSON.parse(window.localStorage.mapee_question_3w);this.question4w=JSON.parse(window.localStorage.mapee_question_4w);this.question5w=JSON.parse(window.localStorage.mapee_question_5w);this.questionDescription=JSON.parse(window.localStorage.mapee_question_description);this.onListenTitle()}else{this.offListenTitle()}}_changeDiag(currentPage,diagId,type){if(this.loadingDiag)return;if(currentPage&&diagId)this.set("loadingDiag",!0);else return;if("new"==diagId){this.getApiKey(key=>{this.$.diag_status_ajax.params={key};this.$.diag_status_ajax.generateRequest();this.set("diagnostic",{})})}else if(24==diagId.length&&type){window.getTransactionMapeeDiag().store.get(diagId).onsuccess=e=>{this._createEmptyQuestions(e.target.result);this.set("diagnostic",e.target.result);this.set("loadingDiag",!1);window.dispatchEvent(new CustomEvent("page-response",{detail:{titleEditable:!0,title:this.diagnostic.name,titleAriaLabel:"Editar nome do Diagnostico"}}));this._changeType(currentPage,diagId,type)}}}_createEmptyQuestions(diag){let create=Object.keys(this.question1w).sort();create=create.concat(Object.keys(this.question2w).sort());create=create.concat(Object.keys(this.question3w).sort());create=create.concat(Object.keys(this.question4w).sort());create=create.concat(Object.keys(this.question1h).sort());create=create.concat(Object.keys(this.question5w).sort());let qs=diag.questions,index=-1;for(let i=0;i<qs.length;i++){index=create.indexOf(qs[i].key);if(0<=index){create.splice(index,1)}}for(let i=0;i<create.length;i++){qs.push({key:create[i],completed:!1,ignore:!1,jump:!1})}let getSize=key=>{switch(key.slice(0,2)){case"1w":return 0;case"2w":return 100;case"3w":return 200;case"4w":return 300;case"1h":return 400;case"5w":return 500;}};qs.sort((a,b)=>{let aSize=parseInt(a.key.slice(2,4))+getSize(a.key),bSize=parseInt(b.key.slice(2,4))+getSize(b.key);return aSize-bSize});qs.forEach(q=>{let question=this[`question${q.key.slice(0,2)}`];q.relevance=!!question[q.key].relevance})}_changeType(currentPage,diagId,type){if(currentPage&&24==diagId.length&&!this.loadingQuestion){this.set("loadingQuestion",!0);switch(!0){case"restart"==type:this._restartDiag();break;case"continue"==type:case /^[1-5](w|h)$/.test(type):this._calcStartQuestion();break;case /^[1-5](w|h)\d{1,2}$/.test(type):this._setQuestionData(type);break;}}}_restartDiag(){this.getApiKey(key=>{this.$.question_reset_ajax.body={key,id:this.diagrouteData.diag};this.$.question_reset_ajax.generateRequest()})}_responseQuestionary(e){let res=e.detail.response;this.set("loadingDiag",!1);if(res.success){window.getTransactionMapeeDiag().store.put(res).onsuccess=e=>{window.setLocation(`diagnosticos/${e.target.result}/continue`)}}}_calcStartQuestion(){if(this.diagnostic&&this.diagnostic._id){this._sortQuestions();let qs=this.diagnostic.questions,target=null,oldTarget=null,stop="continue"!=this.subrouteData.type,type=stop?this.subrouteData.type:null;if(type){for(let i=0;i<qs.length;i++){oldTarget=target;if(qs[i].key.slice(0,2)==type){target=qs[i]}else{target=null}if(oldTarget&&!target){this._setQuestion(oldTarget.key);break}if(target&&!target.completed&&!target.ignore&&!target.jump){this._setQuestion(target.key);break}}}else{for(let i=0;i<qs.length;i++){target=qs[i];if(i+1>=qs.length){this._setQuestion(target.key);break}if(target&&!target.completed&&!target.ignore&&!target.jump){this._setQuestion(target.key);break}}}this.set("loadingQuestion",!1)}else setTimeout(this._calcStartQuestion.bind(this),200)}_sortQuestions(){this.diagnostic.questions.sort((a,b)=>{let va=0,vb=0;switch(a.key.slice(0,2)){case"1w":va=0;break;case"2w":va=100;break;case"3w":va=200;break;case"4w":va=300;break;case"1h":va=400;break;case"5w":va=500;break;}switch(b.key.slice(0,2)){case"1w":vb=0;break;case"2w":vb=100;break;case"3w":vb=200;break;case"4w":vb=300;break;case"1h":vb=400;break;case"5w":vb=500;break;}va+=parseInt(a.key.slice(2,4));vb+=parseInt(b.key.slice(2,4));return va-vb})}_setQuestion(question){window.setLocation(`diagnosticos/${this.diagrouteData.diag}/${question}`,!/^[1-5](w|h)\d{1,2}$/.test(this.subrouteData.type))}_setQuestionData(type){if(this.diagnostic&&this.diagnostic._id){if("string"===typeof type){let qs=this.diagnostic.questions,qg=[],group=type.slice(0,2);for(let i=0;i<qs.length;i++){if(qs[i].key.slice(0,2)==group)qg.push(qs[i])}this.set("questionsGroup",qg);for(let i=0;i<qs.length;i++){if(qs[i].key==type){this.set("question",qs[i]);this._setStepperContent(this.question);this._tryJumpPreviousQuestions(this.question);break}}}this.set("loadingQuestion",!1)}else setTimeout(this._setQuestionData.bind(this),200,type)}_setStepperContent(q){if(q.gravity){this.shadowRoot.querySelector("#step0").finish();this.set("gutQuestions.0.answer",this.gutQuestions[0].buttons[q.gravity-1].title);this.set("gutQuestions.0.value",q.gravity)}else{this.shadowRoot.querySelector("#step0").restart();this.shadowRoot.querySelector("#step0").attackHeader();this.set("gutQuestions.0.answer","");this.set("gutQuestions.0.value",0)}if(q.urgency){this.shadowRoot.querySelector("#step1").finish();this.set("gutQuestions.1.answer",this.gutQuestions[1].buttons[q.urgency-1].title);this.set("gutQuestions.1.value",q.urgency)}else{this.shadowRoot.querySelector("#step1").restart();this.shadowRoot.querySelector("#step1").attackHeader();this.set("gutQuestions.1.answer","");this.set("gutQuestions.1.value",0)}if(q.trend){this.shadowRoot.querySelector("#step2").finish();this.set("gutQuestions.2.answer",this.gutQuestions[2].buttons[q.trend-1].title);this.set("gutQuestions.2.value",q.trend)}else{this.shadowRoot.querySelector("#step2").restart();this.shadowRoot.querySelector("#step2").attackHeader();this.set("gutQuestions.2.answer","");this.set("gutQuestions.2.value",0)}}_tryJumpPreviousQuestions(question){let group=question.key.slice(0,2),qs=this.diagnostic.questions;for(let i=0,q;i<qs.length;i++){q=qs[i];if(q.key.slice(0,2)!==group)continue;if(!q.completed&&!q.jump&&!q.ignore&&!q.loading){if(parseInt(q.key.slice(2,4))<parseInt(question.key.slice(2,4)))this._questionJump(q);else break}}}_composeNameDiag(name){return name||""}_composeQuestionDescription(question,qd,type){if(/^[1-5](w|h)\d{1,2}$/.test(question)&&qd&&type)for(let i=0;i<qd.length;i++){if(qd[i].name==question.slice(0,2))return qd[i][type]}return""}_computeQuestionData(key){if(!key)return"";let data=this[`question${key.slice(0,2)}`];if(data){return data[key].question}else return""}_selectNextQuestion(e){this._setQuestion(e.detail.question)}_handleAnswer(e){e.model.set("gut.answer",e.detail.title);let gutType=0===e.model.gut.index?"gravity":1===e.model.gut.index?"urgency":"trend";this.question[gutType]=e.detail.value;for(let r in e.model.children){let child=e.model.children[r];if(child&&child.tagName&&"fluido-step"==child.tagName.toLowerCase()){child.finish()}}}_saveQuestionHandler(e){let res=e.detail.response;if(res.key){let qs=this.diagnostic.questions,load=!1;for(let i=0,target;i<qs.length;i++){target=qs[i];if(target.key==res.key){Object.assign(target,res);target.loading=!1;this.$.nquestions.render()}load=load||target.loading}if(!load)this._syncIndexedDB()}else{console.log(res)}}_syncIndexedDB(){window.getTransactionMapeeDiag().store.put(this.diagnostic).onsuccess=()=>{this.$.nquestions.render()}}_resetQuestionHandler(e){this.set("loadingQuestion",!1);if(!e.detail.response.success)console.log(e.detail.response);else this._cleanDiag()}_cleanDiag(){this.diagnostic.questions=[];this._createEmptyQuestions(this.diagnostic);this._syncIndexedDB();this._setQuestion("1w")}_questionJump(question){this.set(["questionsGroup",parseInt(question.key.slice(2,4))-1,"loading"],!0);this.getApiKey(key=>{this.$.question_save_ajax.body={key,question:question.key,jump:!0,id:this.diagrouteData.diag};this.$.question_save_ajax.generateRequest()});setTimeout(()=>{if(this.questionsGroup[parseInt(question.key.slice(2,4))-1].loading){this._questionJump(question)}},1e3)}_questionIgnore(question){this.set(["questionsGroup",parseInt(question.key.slice(2,4))-1,"loading"],!0);this.getApiKey(key=>{this.$.question_save_ajax.body={key,question:question.key,ignore:!0,id:this.diagrouteData.diag};this.$.question_save_ajax.generateRequest()});setTimeout(()=>{if(this.questionsGroup[parseInt(question.key.slice(2,4))-1].loading){this._questionIgnore(question)}},1e3)}_questionComplete(question){this.set(["questionsGroup",parseInt(question.key.slice(2,4))-1,"loading"],!0);this.getApiKey(key=>{this.$.question_save_ajax.body={key,question:question.key,gravity:question.gravity,urgency:question.urgency,trend:question.trend,id:this.diagrouteData.diag};this.$.question_save_ajax.generateRequest()});setTimeout(()=>{if(this.questionsGroup[parseInt(question.key.slice(2,4))-1].loading){this._questionComplete(question)}},1e3)}_questionClickFinish(){this._questionComplete(this.question);if(!this.question.completed&&!this.question.ignore&&!this.question.jump)this._nextQuestion()}_questionClickJump(){if(!this.question.completed&&!this.question.ignore&&!this.question.jump)this._nextQuestion()}_questionClickIgnore(){this._questionIgnore(this.question);if(!this.question.completed&&!this.question.ignore&&!this.question.jump)this._nextQuestion()}_nextQuestion(){let i=parseInt(this.subrouteData.type.slice(2,4));if(i>=this.questionsGroup.length){this._nextQuestionGroup()}else{this._setQuestion(this.subrouteData.type.slice(0,2)+(i+1))}}_nextQuestionGroup(){switch(this.subrouteData.type.slice(0,2)){case"1w":this._setQuestion("2w");this.continueQuestions();break;case"2w":this._setQuestion("3w");this.continueQuestions();break;case"3w":this._setQuestion("4w");this.continueQuestions();break;case"4w":this._setQuestion("1h");this.continueQuestions();break;case"1h":this._setQuestion("5w");this.continueQuestions();break;}}}window.customElements.define(MyPageDiagnostics.is,MyPageDiagnostics);</script></dom-module></body></html>